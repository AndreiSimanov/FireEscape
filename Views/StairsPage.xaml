<?xml version="1.0" encoding="utf-8" ?>
<baseview:BaseStairsPage 
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:dx="clr-namespace:DevExpress.Maui.Core;assembly=DevExpress.Maui.Core"
    xmlns:dxe="clr-namespace:DevExpress.Maui.Editors;assembly=DevExpress.Maui.Editors"
    xmlns:dxdf="clr-namespace:DevExpress.Maui.DataForm;assembly=DevExpress.Maui.Editors"
    xmlns:dxcv="clr-namespace:DevExpress.Maui.CollectionView;assembly=DevExpress.Maui.CollectionView"
    xmlns:lang="clr-namespace:FireEscape.Resources.Languages"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    xmlns:model="clr-namespace:FireEscape.Models"
    xmlns:viewmodel="clr-namespace:FireEscape.ViewModels"
    xmlns:baseview="clr-namespace:FireEscape.Views.BaseViews"
    xmlns:stairselmodel="clr-namespace:FireEscape.Models.StairsElements"
    xmlns:ctrl="clr-namespace:FireEscape.Views.Controls"
    x:Class="FireEscape.Views.StairsPage"
    x:DataType="viewmodel:StairsViewModel"
    Title="{x:Static lang:AppResources.StairsPageTitle}">

    <ScrollView 
        
        BackgroundColor="{dx:ThemeColor Surface}">
        <ScrollView.Resources>
            <ResourceDictionary>
                <toolkit:EnumToBoolConverter x:Key="EnumToBoolConverter" />
            </ResourceDictionary>
        </ScrollView.Resources>

        <VerticalStackLayout>
            <dxe:ComboBoxEdit
                SelectionChanged="StairsTypeChanged"
                Style="{StaticResource DefaultComboBoxEdit}"
                LabelText="{x:Static lang:AppResources.StairsTypesHint}"
                SelectedItem="{Binding EditObject.StairsType}"
                ItemsSource="{Binding StairsSettings.StairsTypes}"/>

            <dxe:ComboBoxEdit
                Style="{StaticResource DefaultComboBoxEdit}"
                LabelText="{x:Static lang:AppResources.StairsMountTypesHint}"
                SelectedItem="{Binding EditObject.StairsMountType}"
                ItemsSource="{Binding StairsSettings.StairsMountTypes}"/>

            <dxe:CheckEdit
                Style="{StaticResource DefaultCheckEdit}"
                IsChecked="{Binding EditObject.IsEvacuation}"
                Label="{x:Static lang:AppResources.EscapeStairs}"/>

            <dxe:CheckEdit
                Style="{StaticResource DefaultCheckEdit}"
                IsChecked="{Binding EditObject.WeldSeamServiceability}"
                Label="{x:Static lang:AppResources.WeldSeamServiceability}"/>

            <dxe:CheckEdit
                Style="{StaticResource DefaultCheckEdit}"
                IsChecked="{Binding EditObject.ProtectiveServiceability}"
                Label="{x:Static lang:AppResources.ProtectiveServiceability}"/>

            <ctrl:ServiceabilityControl
                PlaceholderText ="{Binding StairsWidthHint}"
                LabelText ="{Binding StairsWidth}"
                Value="{Binding EditObject.StairsWidth.Value}"
                Serviceability ="{Binding EditObject.StairsWidth.Serviceability}"
                ServiceabilityTypes ="{Binding StairsSettings.ServiceabilityTypes}"
                RejectExplanationText ="{Binding EditObject.StairsWidth.RejectExplanation}"/>

            <Frame
                IsVisible="{Binding EditObject.StairsType.Type, Converter={StaticResource EnumToBoolConverter}, ConverterParameter={x:Static model:StairsTypeEnum.P1_1}}"
                Style="{StaticResource CardView}" CornerRadius="5" Margin="10" Padding="0,0,0,10">
                <StackLayout>
                    <Grid RowDefinitions="Auto,*">
                        <Label  Text="{Binding EditObject.SupportВeams.Name}" Margin="10,5,0,5"/>
                        <Label   Margin="0,5,10,5" HorizontalTextAlignment="End">
                            <Label.FormattedText>
                                <FormattedString>
                                    <Span Text="{Binding EditObject.SupportВeams.CalcWithstandLoad}" />
                                    <Span Text=" кгс" />
                                </FormattedString>
                            </Label.FormattedText>
                        </Label>
                    </Grid>
                        
                    <dx:DXSeparator SideMargin="0"/>

                    <dxe:NumericEdit
                        Style="{StaticResource DefaultNumericEdit}"
                        Value="{Binding EditObject.SupportВeams.TestPointCount}"
                        PlaceholderText="{x:Static lang:AppResources.TestPointCountHint}"
                        LabelText="{x:Static lang:AppResources.TestPointCount}"/>

                    <ctrl:ServiceabilityControl
                        MaxDecimalDigitCount="1"
                        PlaceholderText ="{Binding DeformationHint}"
                        LabelText ="{Binding Deformation}"
                        Value="{Binding EditObject.SupportВeams.Deformation.Value}"
                        Serviceability ="{Binding EditObject.SupportВeams.Deformation.Serviceability}"
                        ServiceabilityTypes ="{Binding StairsSettings.ServiceabilityTypes}"
                        RejectExplanationText ="{Binding EditObject.SupportВeams.Deformation.RejectExplanation}"/>
                </StackLayout>
            </Frame>

            <dxe:NumericEdit
                Style="{StaticResource DefaultNumericEdit}"
                Value="{Binding EditObject.StepsCount}"
                PlaceholderText="{x:Static lang:AppResources.StepsCountHint}"
                LabelText="{x:Static lang:AppResources.StepsCount}"/>

            <ctrl:ServiceabilityControl
                MaxValue="100"
                MaxDecimalDigitCount="2"
                PlaceholderText ="{x:Static lang:AppResources.StairsHeightHint}"
                LabelText ="{x:Static lang:AppResources.StairsHeight}"
                Value="{Binding EditObject.StairsHeight.Value}"
                ValueChangedCommand="{Binding EditObject.UpdatStairsElementsCommand}"
                Serviceability ="{Binding EditObject.StairsHeight.Serviceability}"
                ServiceabilityTypes ="{Binding StairsSettings.ServiceabilityTypes}"
                RejectExplanationText ="{Binding EditObject.StairsHeight.RejectExplanation}"/>

            <dxe:FormGroupItem Header="Элементы лестницы" HeightRequest="38" Margin="0,0,80,0" />
            <dx:DXButton 
                x:Name="addButton"
                IsEnabled="{Binding IsNotBusy}"
                VerticalOptions="End" HorizontalOptions="End" Margin="0,-40,5,0" Content="+"
                WidthRequest="56" HeightRequest="56" Padding="0"
                FontSize="28" CornerRadius="14" FontAttributes="None"
                Clicked="AddStairsElement">
                <dx:DXButton.Shadow>
                    <Shadow Brush="{dx:ThemeColor Shadow, Alpha=0.3}" Offset="1,2" Radius="10" />
                </dx:DXButton.Shadow>
            </dx:DXButton>

            <dxcv:DXCollectionView 
                x:Name="stairsElements"
                ItemsSource="{Binding EditObject.StairsElements}"
                AllowLiveDataShaping="True"
                SelectionMode="Single"
                ItemSeparatorThickness="0"
                UseRippleEffect="true">
                <dxcv:DXCollectionView.ItemTemplate>
                    <DataTemplate x:DataType="stairselmodel:BaseStairsElement">
                        <dxcv:SwipeContainer>
                            <dxcv:SwipeContainer.EndSwipeItems>
                                <dxcv:SwipeItem 
                                BackgroundColor="#D74F67"
                                IsEnabled="{Binding Source={RelativeSource AncestorType={x:Type viewmodel:StairsViewModel } }, Path=IsNotBusy}"
                                Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodel:StairsViewModel}}, Path=DeleteElementCommand}"
                                CommandParameter="{Binding .}"
                                Caption="{x:Static lang:AppResources.Delete}"
                                Image="delete"/>
                            </dxcv:SwipeContainer.EndSwipeItems>
                            <dxcv:SwipeContainer.ItemView>
                                <Grid Padding="10" HorizontalOptions="Fill">
                                    <Frame HeightRequest="160" Style="{StaticResource CardView}">
                                        <Frame.GestureRecognizers>
                                            <TapGestureRecognizer 
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodel:StairsViewModel}}, Path=GoToDetailsCommand}"
                                            CommandParameter="{Binding .}"/>
                                        </Frame.GestureRecognizers>
                                        <VerticalStackLayout Spacing="2" >
                                            <Label Style="{StaticResource Titleline}" Text="{Binding Name}"/>
                                        </VerticalStackLayout>
                                    </Frame>
                                </Grid>
                            </dxcv:SwipeContainer.ItemView>
                        </dxcv:SwipeContainer>
                    </DataTemplate>
                </dxcv:DXCollectionView.ItemTemplate>
            </dxcv:DXCollectionView>
        </VerticalStackLayout>
    </ScrollView>
</baseview:BaseStairsPage>